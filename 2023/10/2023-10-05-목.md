# 2023-10-05(목)

### 소소한 장애 회고

어제 회사에서 배포를 하다가 장애를 냄. 

배포를 했던 작업은 다음과 같음. 

- 테이블에 제거하고자 하는 컬럼이 있었음.
- 제거 전에 해당 컬럼에는 빈 오브젝트를 JSON 형식으로 변환한 {} 값을 넣기로 함.
- 조회할 때는 클래스의 필드를 모두 nullable로 수정

배포를 시작. 서버 한 대 배포가 끝남과 동시에 슬렉 에러 채널에 무수한 에러가 올라오기 시작함. 

```jsx
UndeclaredThrowableException, (null), {} .. 
```

에러가 난 이유는 

- 코드 이슈는 아니었음. 몇 번의 로컬 테스트를 통해 코드는 이상이 없던 것을 사전에 확인
- **조회하는 로직과, 등록하는 로직을 하나의 브랜치에서 작업하였고 한꺼번에 배포한 것이 원인이었음.**

예를 들면, 

1. 서버 한 대가 배포 완료, 해당 서버로 들어온 API 콜에서 DB에 {} 로 저장됨. 
2. 아직 배포되지 않은 서버에서 DB에 {}로 저장된 데이터를 조회하는 API 콜이 발생
3. 아직 배포되지 않은 서버에는 클래스의 필드를 nullable로 변경한 코드가 반영되지 않았기 때문에 내부 필드가 모두 null인 {}를 조회할 시 UndeclaredThrowableException 에러가 발생

결과적으로 배포 중에 서버 간 배포 시간 차가 있어 발생한 이슈였고, 모든 서버가 배포 완료되면 멈출 에러였음. 

교훈

- 코드를 잘 짜는 것만 중요한 게 아니다. 배포할 시 발생할 수 있는 에러 상황도 고려를 해야 한다.
- 서버 여러 대를 배포하는 경우에, 조회와 등록/수정 로직을 동시에 수정하는 작업이 있다면 동시에 배포하지 말자.
    - 조회 로직을 먼저 배포하고, 그다음 등록/수정 로직을 배포해야 한다. 받아들이는 쪽이 먼저 준비가 되어 있어야 새로운 형태의 데이터를 넣을 수 있다.
    - 비슷한 사례로, publisher와 consumer를 배포할 일이 있다면 consumer를 먼저 배포하고 그다음 publisher를 배포해야 한다.
- 어려운 이슈는 아니었지만 몇 분 사이에 약 2000개의 데이터가 빈 오브젝트 값으로 들어갔고, 결국 데이터 보정 작업도 하게 되었다. 타팀에서 에러 문의도 많이 들어왔다. 방대한 양의 데이터를 가지고 있는 커머스 기업에서, 게다가 커머스의 메인 데이터인 상품을 관리하는 상품 시스템팀에서 일하고 있기 때문에 데이터의 변형이 발생하는 작업에 더욱이 신중을 기울여야겠다고 반성한다.