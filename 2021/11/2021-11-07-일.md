# [Elasticsearch] μ‹μ¤ν… κµ¬μ΅°

π–π»μ¤λλ§μ— ν•λ” μ—λΌμ¤ν‹±μ„μΉ κ³µλ¶€

μ—λΌμ¤ν‹±μ„μΉλ¥Ό μ΄λ£¨λ” μ‹μ¤ν… κµ¬μ΅°λ¥Ό μ‚΄ν΄λ³΄μ. μ‚΄ν΄λ³Ό κµ¬μ΅°λ” ν¬κ² λ‹¤μκ³Ό κ°™μ΄ λ¶„λ¥ν•  μ μλ‹¤.

[ν΄λ¬μ¤ν„°, λ…Έλ“]

- ν΄λ¬μ¤ν„°: κ°€μ¥ ν° μ‹μ¤ν… λ‹¨μ„
- λ…Έλ“: ν”„λ΅μ„Έμ¤ λ‹¨μ„

[μƒ‰μΈ λ λ°μ΄ν„°λ¥Ό μ €μ¥ν•λ” λ©”μ»¤λ‹μ¦]

- μƒ¤λ“
- λ³µμ‚¬λ³Έ

<br/>

## ν΄λ¬μ¤ν„°μ™€ λ…Έλ“

ν΄λ¬μ¤ν„°(Cluster): μ—λΌμ¤ν‹±μ„μΉμ κ°€μ¥ ν° μ‹μ¤ν… λ‹¨μ„

ν΄λ¬μ¤ν„°μ νΉμ§•μ€ λ‹¤μκ³Ό κ°™λ‹¤. 

- ν•λ‚μ ν΄λ¬μ¤ν„°λ” μ—¬λ¬λ€μ λ…Έλ“(Node)λ΅ μ΄λ¤„μ§„λ‹¤.
- μ„λ΅ λ‹¤λ¥Έ ν΄λ¬μ¤ν„°λ” λ°μ΄ν„°μ μ ‘κ·Όμ΄λ‚ κµν™μ„ ν•  μ μ—†λ” λ…λ¦½μ μΈ μ‹μ¤ν…μΌλ΅ μ μ§€λλ‹¤.
- μ—¬λ¬λ€μ μ„λ²„κ°€ ν•λ‚μ ν΄λ¬μ¤ν„°λ¥Ό κµ¬μ„±ν•  μλ„ μμΌλ©°, λ°λ€λ΅ ν•λ‚μ λ¬Όλ¦¬μ μΈ μ„λ²„μ— μ—¬λ¬κ°μ ν΄λ¬μ¤ν„°κ°€ μ΅΄μ¬ν•  μλ„ μλ‹¤.

<br/>

μ—¬λ¬λ€μ λ…Έλ“λ΅ ν΄λ¬μ¤ν„°λ¥Ό κµ¬μ„±ν•λ” λ°©λ²•μ€ λ§¤μ° κ°„λ‹¨ν•λ‹¤. 

κ°™μ€ μ‹μ¤ν…, λλ” λ„¤νΈμ›ν¬ λ°”μΈλ”©μ΄ λλ„λ΅ μ„¤μ •ν• λ‹¤λ¥Έ μ‹μ¤ν…μ—μ„ ν΄λ¬μ¤ν„°λ…μ΄ κ°™μ€ μ—λΌμ¤ν‹±μ„μΉλ¥Ό μ‹¤ν–‰ν•λ©΄ λ‘ κ°μ λ…Έλ“κ°€ ν•λ‚μ ν΄λ¬μ¤ν„°λ΅ λ°”μΈλ”© λμ–΄ λ¬¶μΈλ‹¤. 

ν΄λ¬μ¤ν„°λ…μ€ config/elasticsearch.yml νμΌμ—μ„ cluster.nameμ„ μ„¤μ •ν•λ©΄ λλ‹¤. 

μ΄λ ‡κ² μ—λΌμ¤ν‹±μ„μΉλ” ν΄λ¬μ¤ν„°λ…μ„ κ°™κ² μ μ§€ν•λ” κ²ƒλ§μΌλ΅ μ†μ‰½κ² ν•λ‚μ μ‹μ¤ν…μΌλ΅ λ¬¶μ„ μ μλ‹¤. 

μ‹μ¤ν…μ ν™•μ¥μ΄ ν•„μ”ν•λ‹¤λ©΄ ν΄λ¬μ¤ν„°λ…λ§ κ°™κ² μ μ§€ν•κ³  μƒλ΅μ΄ μ—λΌμ¤ν‹±μ„μΉ ν”„λ΅μ„Έμ¤λ¥Ό μ‹¤ν–‰ν•λ©΄ λλ” κ²ƒμ΄λ‹¤. μ”μ¦κ³Ό κ°™μ΄ μλ§μ€ λ°μ΄ν„°λ¥Ό μ²λ¦¬ν•κΈ° μ„ν•΄ μμ‹λ΅ μ¤μΌ€μΌ μ—…(Scale-Up), μ¤μΌ€μΌ μ•„μ›ƒ(Scale-Out)μ„ μ”κµ¬ν•λ” μ‹μ¤ν…μ—λ” λ”ν•  λ‚μ„ μ—†μ΄ μ ν•©ν• κΈ°λ¥μ„ μ κ³µν•λ‹¤. 

<br/>

### λ…Έλ“ λ°”μΈλ”©

λ΅μ»¬μ—μ„ μ‹¤μ λ΅ μ—λΌμ¤ν‹±μ„μΉλ¥Ό μ‹¤ν–‰ν•λ©΄μ„ ν΄λ¬μ¤ν„°μ™€ λ…Έλ“κ°€ μ–΄λ–¤μ‹μΌλ΅ κµ¬μ„±λλ”μ§€ μ‚΄ν΄λ³΄κ² λ‹¤. 

λ¨Όμ € λ΅μ»¬μ— μ•λΌμ¤ν‹±μ„μΉλ¥Ό μ„¤μΉν•κ³  μ‹¤ν–‰ν•΄λ³΄μ. λ°©λ²•μ€ μ•„λ λ§ν¬λ¥Ό μ°Έκ³ ν•λ‹¤. 

π“ [https://programmer-chocho.tistory.com/25?category=935648](https://programmer-chocho.tistory.com/25?category=935648)

<br/>
ν΄λ¬μ¤ν„° κµ¬μ„±μ„ μ„ν•΄ μ—λΌμ¤ν‹±μ„μΉ μ••μ¶•νμΌμ„ λ‘λ²ν’€μ–΄ κ°κ° λ‹¤λ¥Έ ν΄λ”μ— λ„£μ–΄μ£Όμ—λ‹¤. 

<img src="https://user-images.githubusercontent.com/52793122/140644761-31bb05a8-c78a-4095-9bd9-c10085392151.png"  width="300" height="150"/>

<br/>
<br/>

κ·Έ λ‹¤μ, μ—λΌμ¤ν‹±μ„μΉλ¥Ό νΈν•κ² λ‹¤λ£¨κΈ° μ„ν• μ—λΌμ¤ν‹±μ„μΉ ν—¤λ“ ν”λ¬κ·ΈμΈλ„ μ„¤μΉν•μ. 

μ•„λ λ§ν¬λ¥Ό μ°Έκ³ ν•λ‹¤. 

π“ [https://programmer-chocho.tistory.com/26?category=935648](https://programmer-chocho.tistory.com/26?category=935648)

λ‹¤μμΌλ΅ μ—λΌμ¤ν‹±μ„μΉ λ‘κ° λ¨λ‘ config/elasticsearch.ymlνμΌμ„ μ—΄κ³  κ° λ…Έλ“λ…, ν΄λ¬μ¤ν„°λ…μ„ μ„¤μ •ν•λ‹¤. 

<br/>

elasticsearch-1
```java
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
cluster.name: es_test
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
node.name: "node_1"
```

<br/>

elasticsearch-2

```java
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
cluster.name: es_test
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
node.name: "node_2"
```

<br/>

μ—λΌμ¤ν‹±μ„μΉλ¥Ό μ‹¤ν–‰ν•λ‹¤. μ‹¤ν–‰ λ΅κ·Έ λ‡ μ¤„μ„ μ½μΌλ©° es μ •λ³΄λ¥Ό μ‚΄ν΄λ³΄μ. 

<br/>
elasticsearch-1

```java
// ν„μ¬ λ…Έλ“κ°€ 9300λ² ν¬νΈλ¥Ό μ‚¬μ©ν•΄μ„ λ°μ΄ν„° ν†µμ‹ μ„ ν•κ³  μμμ„ μλ―Έν•λ‹¤.
[2021-11-07T17:30:16,226][INFO ][o.e.t.TransportService   ] [node_1] publish_address {127.0.0.1:9300}, bound_addresses {[::1]:9300}, {127.0.0.1:9300}

// μ—λΌμ¤ν‹±μ„μΉμ http ν†µμ‹ , REST APIκ°€ 9200λ² ν¬νΈλ¥Ό ν†µν•΄μ„ μ‹¤ν–‰λκ³  μμμ„ μλ―Έν•λ‹¤. 
[2021-11-07T17:30:16,678][INFO ][o.e.h.AbstractHttpServerTransport] [node_1] publish_address {127.0.0.1:9200}, bound_addresses {[::1]:9200}, {127.0.0.1:9200}
```

<br/>
elasticsearch-2

```java
// ν„μ¬ λ…Έλ“κ°€ 9301λ² ν¬νΈλ¥Ό μ‚¬μ©ν•΄μ„ λ°μ΄ν„° ν†µμ‹ μ„ ν•κ³  μμμ„ μλ―Έν•λ‹¤.
// λ””ν΄νΈκ°€ 9300μ΄κ³ , 9300μ„ λ‹¤λ¥Έ λ…Έλ“κ°€ μ μ ν•κ³  μλ” κ²½μ° 9300 ~ 9399 μ‚¬μ΄μ κ°’μ„ μ°¨λ΅€λ€λ΅ μ‚¬μ©ν•λ‹¤. 
[2021-11-07T17:31:54,030][INFO ][o.e.t.TransportService   ] [node_2] publish_address {127.0.0.1:9301}, bound_addresses {[::1]:9301}, {127.0.0.1:9301}

// μ—λΌμ¤ν‹±μ„μΉμ http ν†µμ‹ , REST APIκ°€ 9201λ² ν¬νΈλ¥Ό ν†µν•΄μ„ μ‹¤ν–‰λκ³  μμμ„ μλ―Έν•λ‹¤.
// λ””ν΄νΈκ°€ 9200μ΄κ³ , 9200μ„ λ‹¤λ¥Έ λ…Έλ“κ°€ μ μ ν•κ³  μλ” κ²½μ° 9200 ~ 9299 μ‚¬μ΄μ κ°’μ„ μ°¨λ΅€λ€λ΅ μ‚¬μ©ν•λ‹¤.  
[2021-11-07T17:31:55,031][INFO ][o.e.h.AbstractHttpServerTransport] [node_2] publish_address {127.0.0.1:9201}, bound_addresses {[::1]:9201}, {127.0.0.1:9201}
```

<br/>
ν—¤λ“ ν”λ¬κ·ΈμΈμ— μ ‘μ†ν•μ—¬ ν΄λ¬μ¤ν„° μƒνƒλ¥Ό ν™•μΈν•΄λ³΄μ. 

<img src="https://user-images.githubusercontent.com/52793122/140644762-4e5b5d1a-90ac-4381-8d73-429c279fa161.png"  width="900" height="300"/>

μ™Όμ½μ λ³„λ¨μ–‘μ€ ν•΄λ‹Ή λ…Έλ“κ°€ ν΄λ¬μ¤ν„°μ λ§μ¤ν„° λ…Έλ“μ„μ„ μλ―Έν•λ‹¤.

λ΅μ»¬μ—μ„ κµ¬μ„±ν• ν΄λ¬μ¤ν„° κµ¬μ΅°λ¥Ό κ·Έλ¦ΌμΌλ΅ λ‚νƒ€λ‚΄λ©΄ λ‹¤μκ³Ό κ°™λ‹¤. 

<img src="https://user-images.githubusercontent.com/52793122/140644763-c33e2de7-7a3a-43cd-bead-ebd93b5d8e36.png"  width="550" height="300"/>

ν•λ‚μ μ„λ²„μ—μ„ μ—¬λ¬κ°μ μ—λΌμ¤ν‹±μ„μΉ λ…Έλ“κ°€ μ‹¤ν–‰λ  λ• λ…Έλ“ μ‚¬μ΄μ λ°”μΈλ”©μ„ μ„ν• ν†µμ‹  ν¬νΈλ” 9300λ¶€ν„° μ°¨λ΅€λ€λ΅ μƒμ„±λλ‹¤. κ·Έλ¦¬κ³  REST API ν†µμ‹ μ„ μ„ν• ν¬νΈλ” 9200λ¶€ν„° μ°¨λ΅€λ€λ΅ μƒμ„±λλ‹¤. 

<br/>

### λ§μ¤ν„° λ…Έλ“μ™€ λ°μ΄ν„° λ…Έλ“

μ—λΌμ¤ν‹±μ„μΉμ—λ” λ‹¤μκ³Ό κ°™μ€ μΆ…λ¥μ λ…Έλ“κ°€ μλ‹¤. 

- λ§μ¤ν„° λ…Έλ“
    - μ „μ²΄ ν΄λ¬μ¤ν„°μ μƒνƒμ— λ€ν• λ©”νƒ€ μ •λ³΄λ¥Ό κ΄€λ¦¬ν•λ” λ…Έλ“
    - κΈ°μ΅΄μ λ§μ¤ν„° λ…Έλ“κ°€ μΆ…λ£λλ©΄ μƒλ΅μ΄ λ§μ¤ν„° λ…Έλ“κ°€ μ„ μ¶λλ‹¤. 
    elasticsearch.yml νμΌμ—μ„ node.master μ†μ„±μ΄ trueμΈ λ…Έλ“λ” λ§μ¤ν„° λ…Έλ“λ΅ μ„ μ¶λ  μ μλ‹¤. 
    μ„ μ¶λ  κ°€λ¥μ„±μ΄ μλ‹¤λ” λ»μ΄μ§€, λ°λ“μ‹ μ„ μ¶λλ‹¤λ”κ±΄ μ•„λ‹. falseλ΅ μ§€μ •ν•λ©΄ λ§μ¤ν„° λ…Έλ“λ΅ μ„ μ¶λμ§€ μ•λ”λ‹¤.
    
- λ°μ΄ν„° λ…Έλ“:
    - μƒ‰μΈλ λ°μ΄ν„°λ¥Ό μ‹¤μ λ΅ μ €μ¥ν•λ” λ…Έλ“
    - [node.dat](http://node.date)a μ†μ„±μ„ falseλ΅ μ§€μ •ν•λ©΄ ν•΄λ‹Ή λ…Έλ“λ” λ°μ΄ν„°λ¥Ό μ €μ¥ν•μ§€ μ•λ”λ‹¤.

λ‘ λ…Έλ“μ μ†μ„±μ„ ν…μ¤νΈν•΄λ³΄κΈ° μ„ν•΄ elasticsearch.yml νμΌμ„ λ‹¤μκ³Ό κ°™μ΄ μμ •ν•΄λ³΄μ. 

<br/>
elasticsearch-1

```java
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
cluster.name: es_test
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
node.name: "node_1"
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
node.master: true
node.data: false
```

<br/>
elasticsearch-2

```java
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
cluster.name: es_test
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
node.name: "node_2"
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
node.master: false
node.data: true
```

<br/>

node_1κ³Ό node_2λ¥Ό κ°κ° μ‹¤ν–‰ν•λ‹¤. 

κ·Έλ¦¬κ³  μ—λΌμ¤ν‹±μ„μΉμ— books/book/1 λ„νλ¨ΌνΈλ¥Ό ν•λ‚ μ…λ ¥ν•΄λ³΄μ. 

λ‘ κ°μ λ…Έλ“λ” μ„λ΅ λ°”μΈλ”© λΌ ν•λ‚μ μ‹μ¤ν…μ„ μ΄λ£¨κ³  μμΌλ―€λ΅ μ–΄λ–¤ κ²½λ΅λ΅λ„ μ…λ ¥ν•κ±°λ‚ μ΅°νν•  μ μλ‹¤. 

```java
// 9200 ν¬νΈλ΅ λ°μ΄ν„° μ…λ ¥
kimchowon@gimchowon-ui-MacBookPro ~ % curl -XPUT http://localhost:9200/books/book/1 -d '
{"title" : "Elasticsearch Guide",
"author" : "Kim",
"date" : "2014-05-01",
"pages" : 250
}' -H 'Content-Type: application/json'
{"_index":"books","_type":"book","_id":"1","_version":1,"result":"created","_shards":{"total":2,"successful":1,"failed":0},"_seq_no":0,"_primary_term":1}%     kimchowon@gimchowon-ui-MacBookPro ~ % 
kimchowon@gimchowon-ui-MacBookPro ~ % 

// 9201 ν¬νΈλ΅ λ°μ΄ν„° μ΅°ν
kimchowon@gimchowon-ui-MacBookPro ~ % curl -XGET "http://localhost:9201/books/book/1?pretty"
{
  "_index" : "books",
  "_type" : "book",
  "_id" : "1",
  "_version" : 1,
  "_seq_no" : 0,
  "_primary_term" : 1,
  "found" : true,
  "_source" : {
    "title" : "Elasticsearch Guide",
    "author" : "Kim",
    "date" : "2014-05-01",
    "pages" : 250
  }
}
```

<br/>

ν—¤λ“ ν”λ¬κ·ΈμΈμΌλ΅ λ‹¤μ‹ ν™•μΈν•΄λ³΄μ. 

<img src="https://user-images.githubusercontent.com/52793122/140644764-a679dedd-91b0-453e-82de-bb81922fa201.png"  width="900" height="300"/>

κ°‘μκΈ° UnassignedλΌλ” ν•­λ³µμ΄ λ³΄μ΄κ³  μ¤λ¥Έμ½ μƒλ‹¨μ— cluster healthκ°€ yellowλ΅ λμ–΄ μλ‹¤. 

μ—λΌμ¤ν‹±μ„μΉμ— μƒ‰μΈλ λ°μ΄ν„°λ“¤μ€ μƒ¤λ“(Shard)μ™€ λ³µμ‚¬λ³Έ(Replica)μΌλ΅ κµ¬μ„±λΌ μ €μ¥λλ”λ°, ν„μ¬ λ°μ΄ν„°λ¥Ό μ €μ¥ν•λ” λ…Έλ“κ°€ node_2 ν•λ‚λ°–μ— μ—†μ–΄μ„ λ³µμ‚¬λ³Έμ μ €μ¥μ΄ μ΄λ¤„μ§€μ§€ μ•μ•λ‹¤. 

λ”°λΌμ„ λ³µμ‚¬λ³Έ λ°μ΄ν„°λ” ν„μ¬ λ―Έν• λ‹Ή(Unassigned) μƒνƒμ΄κ³ , λ―Έν• λ‹Ή μƒνƒμ λ°μ΄ν„°κ°€ μ΅΄μ¬ν•λ―€λ΅ ν΄λ¬μ¤ν„°μ μƒνƒλ” yellowλ‹¤. 

<br/>

μ—λΌμ¤ν‹±μ„μΉμ λ…Έλ“λ¥Ό ν•λ‚ λ” λ„μ›λ³΄μ. 

elasticsearch-3 ν΄λ”λ¥Ό λ§λ“¤κ³  μ—λΌμ¤ν‹±μ„μΉ μ••μ¶•νμΌμ„ ν‘Όλ‹¤. 

λ…Έλ“ μ΄λ¦„κ³Ό λ…Έλ“ μµμ…μ„ λ‹¤μκ³Ό κ°™μ΄ μ„¤μ •ν•λ‹¤. 

```java
# ---------------------------------- Cluster -----------------------------------
#
# Use a descriptive name for your cluster:
#
cluster.name: es_test
#
# ------------------------------------ Node ------------------------------------
#
# Use a descriptive name for the node:
#
node.name: node_3
#
# Add custom attributes to the node:
#
#node.attr.rack: r1
#
node.master: false
node.data: true
```

<img src="https://user-images.githubusercontent.com/52793122/140644767-1b66c0af-7f23-4345-a95d-3d8d915a8d2e.png"  width="900" height="300"/>

node_3μΈ λ°μ΄ν„° λ…Έλ“κ°€ μ¶”κ°€λ΅ μƒμ„±λ λ¨μµμ„ ν™•μΈν•  μ μλ‹¤. κΈ°μ΅΄μ— λ―Έν• λ‹Ή μƒνƒμ€λ λ°μ΄ν„°κ°€ node_3μ— ν• λ‹Ήλλ©΄μ„ ν΄λ¬μ¤ν„° μƒνƒλ΅ greenμΌλ΅ λμ•„μ™”λ‹¤.

<br/>

## βπ»  λ§λ¬΄λ¦¬
λ§μ¤ν„° λ…Έλ“μ™€ λ°μ΄ν„° λ…Έλ“κ°€ λ°λ“μ‹ μƒνΈ λ² νƒ€μ μΈ κ΄€κ³„λ” μ•„λ‹λ‹¤. 

λ§μ¤ν„° λ…Έλ“κ°€ falseμ΄λ©΄μ„ λ™μ‹μ— λ°μ΄ν„° λ…Έλ“λ„ falseμΈ λ…Έλ“λ„ μ΅΄μ¬ν•  μ μλ‹¤. μ΄λ¬ν• λ…Έλ“λ” μƒ‰μΈκ³Ό κ²€μƒ‰μ„ μ„ν• λ…λ Ήμ–΄ μ „λ‹¬ν•λ” μ—­ν• λ΅λ§ μ΅΄μ¬ν•λ‹¤. 

λ³΄ν†µμ ν΄λ¬μ¤ν„°λ¥Ό κµ¬μ„±ν•  λ• λ§μ¤ν„° λ…Έλ“λ” λ…λ Ή μν–‰μ„ μ „λ‹΄ν•κ³  λ°μ΄ν„° λ…Έλ“λ” http ν†µμ‹  κΈ°λ¥μ„ λ§‰μ•„ λ†“μ•„ REST API μ ‘κ·Όμ„ μ°¨λ‹¨ν•κ³  λ°μ΄ν„°λ¥Ό μ €μ¥ν•λ” μ—­ν• λ§μ„ μ „λ‹΄ν•λ„λ΅ μ„¤μ •ν•λ” κ²ƒμ΄ μΌλ°μ μ΄λ‹¤.